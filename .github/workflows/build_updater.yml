name: Building updater

on:
  push:
    branches:
      - main
    paths:
      - 'src/logic/update/updater.go'
  workflow_dispatch:

jobs:
  updateversion:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v3
    
    - name: Bump Version
      run: |
        version=$(cat "src/logic/version/updater_VERSION.txt")
        files=("src/logic/version/updater_VERSION.txt")

        for i in "${files[@]}"
        do
          echo -n "$(($version + 1))" > "$i"
        done

        git config --local user.name "github-actions[bot]"
        git config --local user.email "github-actions[bot]@users.noreply.github.com"

        git add .
        git commit -m "Version bump to $(($version + 1))" -m "For any changes, check the previous (${{github.event.after}}) commit."
        git push

  linuxbuild:
    runs-on: ubuntu-latest
    needs: updateversion
    steps:
    - name: Checkout
      uses: actions/checkout@v3
    
    - name: Setup Go Environment
      uses: actions/setup-go@v4
      with:
        go-version: '1.20'
        check-latest: true
        
    - name: Main Linux Build
      run: |
        echo "Updating Go Dependencies"
        go get -u
                
        echo "Building 64bit Updater"
        go build -ldflags="-s -w" -v -o updater-amd64 updater.go
        
        echo "Building 32bit Updater"
        GOARCH=386 go build -ldflags="-s -w" -v -o updater-i386 updater.go
        
        echo "Zipping Files"
        7z a updater-linux.zip updater-amd64 updater-i386 ../../../LICENSE
        
        echo "Ok."
      working-directory: src/logic/update
                                  
    - name: Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: 'updater'
        files: |
          src/logic/update/updater-linux.zip
          
  macbuild:
    runs-on: macos-latest
    needs: updateversion
    steps:
    - name: Checkout
      uses: actions/checkout@v3
    
    - name: Setup Go Environment
      uses: actions/setup-go@v4
      with:
        go-version: '1.20'
        check-latest: true
    
    - name: Main MacOS Build
      run: |
        echo "Updating Go Dependencies"
        go get -u
                
        echo "Building Intel Updater"
        go build -ldflags="-s -w" -v -o updater-amd64 updater.go

        echo "Building M1 Updater"
        GOARCH=arm64 go build -ldflags="-s -w" -v -o updater-arm64 updater.go
        
        echo "Zipping Files"
        7z a updater-darwin.zip updater-amd64 updater-arm64 ../../../LICENSE
        
        echo "Ok."
      working-directory: src/logic/update
                          
    - name: Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: 'updater'
        files: |
          src/logic/update/updater-darwin.zip
          
  winbuild:
    runs-on: windows-latest
    needs: updateversion
    steps:
    - name: Checkout
      uses: actions/checkout@v3
    
    - name: Setup Go Environment
      uses: actions/setup-go@v4
      with:
        go-version: '1.20'
        check-latest: true

    - name: Main Windows Build
      run: |
        echo "Updating Go Dependencies"
        go get -u
        
        echo "Adding Time to Github Env"
        echo "RNAME=$(Get-Date -UFormat 'snapshot %Y-%m-%d %H:%M')" >> $env:GITHUB_ENV
        echo "RTXT=$(Get-Date -UFormat '### This release was automatically generated on %A %Y/%m/%d at %H:%M')" >> $env:GITHUB_ENV
        
        echo "Building 64bit Updater"
        go build -ldflags="-s -w" -v -o updater-amd64.exe updater.go
        
        echo "Building 32bit Updater"
        $Env:GOARCH = '386'
        go build -ldflags="-s -w" -v -o updater-i386.exe updater.go
        
        echo "Zipping Files"
        7z a updater-windows.zip updater-amd64.exe updater-i386.exe ../../../LICENSE
        
        echo "Ok."
      working-directory: src/logic/update
                                
    - name: Release
      uses: softprops/action-gh-release@v1
      with:
        name: ${{ env.RNAME }}
        body: ${{ env.RTXT }}
        tag_name: 'updater'
        files: |
          src/logic/update/updater-windows.zip
