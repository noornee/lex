"use strict";

window.onload = function() {
    loadHLS();
}

function loadHLS() {
    if (Hls.isSupported()) {
        //todo: change to queryselector: video.notinit?
        //this searches all videos, which may be slow after a while...
        var videos = document.querySelectorAll("video")
        videos.forEach(function(v) {
            if (!v.hasAttribute("hlsinit")) {
                var playel = function() {
                    var source = v.children[0].src;

                    if (source.includes("HLSPlaylist.m3u8"))
                    {
                        var hls = new Hls({autoStartLoad: false});

                        hls.on(Hls.Events.MANIFEST_PARSED, function() {
                            var lvls = hls.levels;
                            if (lvls.length > 0) {
                                hls.startLevel = lvls.length - 1;
                            }
                        });

                        hls.loadSource(source);
                        hls.attachMedia(v);
                        hls.startLoad();

                        v.play();
                    }
                    v.setAttribute("hlsinit", "");

                    v.removeEventListener("play", playel)
                }
                v.addEventListener("play", playel);
            }
        })
    }
}